<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Royal Diamond Casino</title>
    
    <!-- Fonts: Inter & Rajdhani -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs (Compat version for easy vanilla JS usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            /* Palette: Dark Premium */
            --bg-body: #050b14;
            --bg-surface: #0f1724;
            --bg-card: #162030;
            --bg-glass: rgba(22, 32, 48, 0.7);
            
            --primary: #fbbf24; /* Gold */
            --primary-glow: rgba(251, 191, 36, 0.3);
            --secondary: #38bdf8; /* Cyan */
            --accent: #f43f5e; /* Pink/Red */
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --success: #10b981;
            --danger: #ef4444;
            
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            
            --safe-area-bottom: env(safe-area-inset-bottom);
            --nav-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Background Effects --- */
        .bg-blob {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--primary-glow) 0%, transparent 70%);
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
            pointer-events: none;
        }

        /* --- Header --- */
        header {
            z-index: 10;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(5,11,20,0.95) 0%, rgba(5,11,20,0.8) 100%);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            object-fit: cover;
            background: #2a3344;
        }

        .profile-info h2 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-main);
        }
        .profile-info span {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .balance-pill {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 6px 14px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .balance-amount {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
        }

        /* --- Main Layout --- */
        main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            z-index: 1;
            padding: 16px;
            padding-bottom: 100px; /* Space for nav */
            scrollbar-width: none; 
        }
        main::-webkit-scrollbar { display: none; }

        .tab-view {
            display: none;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .tab-view.active { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.5rem;
            margin: 20px 0 16px 0;
            color: var(--text-main);
        }
        h3 { font-family: 'Rajdhani'; margin: 0 0 10px 0; color: var(--text-muted); font-size: 1.1rem; }

        /* --- Components --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.03);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #d97706);
            color: #000;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.25);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
        }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-secondary:active { background: rgba(255,255,255,0.2); }

        /* --- Home: Games --- */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .game-card {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .game-card:active { background: var(--bg-card); transform: scale(0.96); }
        .game-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--text-main);
            margin-bottom: 10px;
        }
        .game-name { font-weight: 600; font-size: 0.95rem; }

        /* --- Game Interface (The "Active" Area) --- */
        #game-stage {
            display: none; /* Hidden by default */
            margin-top: 20px;
            background: linear-gradient(180deg, rgba(22,32,48,0.9) 0%, rgba(5,11,20,0.95) 100%);
            backdrop-filter: blur(12px);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            padding: 5px;
        }

        .game-visual {
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
        }

        /* Specific Game Styles */
        .mines-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            width: 100%;
        }
        .mine-cell {
            aspect-ratio: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .mine-cell.safe { background: var(--bg-card); border: 1px solid var(--success); color: var(--success); }
        .mine-cell.boom { background: var(--danger); color: white; animation: shake 0.4s; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .dice-circle {
            width: 100px;
            height: 100px;
            background: var(--bg-surface);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            border: 2px solid var(--secondary);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
        }

        .bet-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .bet-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 12px;
            border-radius: var(--radius-sm);
            width: 100%;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            text-align: center;
        }

        /* --- Ranking List --- */
        .rank-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .rank-row:last-child { border-bottom: none; }
        .rank-num { width: 30px; font-weight: 700; color: var(--text-muted); font-family: 'Rajdhani'; }
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        .rank-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, var(--bg-surface), #2a3344);
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            overflow: hidden;
        }
        .rank-avatar img { width:100%; height:100%; object-fit:cover; }
        .rank-info { flex: 1; }
        .rank-name { font-weight: 600; font-size: 0.95rem; }
        .rank-val { font-family: 'Rajdhani'; font-weight: 700; color: var(--primary); }

        /* --- Wallet --- */
        .wallet-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .w-stat {
            flex: 1;
            background: var(--bg-card);
            padding: 15px;
            border-radius: var(--radius-md);
            text-align: center;
        }
        .w-stat small { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }
        .w-stat div { font-family: 'Rajdhani'; font-size: 1.2rem; font-weight: 700; margin-top: 5px; }

        /* --- Friends --- */
        .invite-card {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            text-align: center;
            padding: 30px 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .ref-box {
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Rajdhani';
            font-size: 1.2rem;
            letter-spacing: 2px;
            margin: 15px 0;
            border: 1px dashed var(--secondary);
            word-break: break-all;
        }

        /* --- Tasks --- */
        .task-card {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .task-img {
            width: 60px; height: 60px;
            border-radius: 10px;
            object-fit: cover;
        }

        /* --- Settings --- */
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .setting-item {
            background: var(--bg-card);
            padding: 15px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .setting-left { display: flex; align-items: center; gap: 12px; }

        /* --- ADMIN PANEL STYLES --- */
        #admin-view {
            display: none;
        }
        .admin-dashboard {
            padding: 10px;
        }
        .admin-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        .admin-table-container {
            overflow-x: auto;
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .admin-table th { text-align: left; color: var(--text-muted); padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .admin-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .action-link { color: var(--secondary); cursor: pointer; margin-right: 10px; }
        .action-link.delete { color: var(--danger); }

        /* --- Navigation --- */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(5, 11, 20, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-bottom: var(--safe-area-bottom);
            z-index: 50;
            height: calc(var(--nav-height) + var(--safe-area-bottom));
        }

        .nav-bar {
            display: flex;
            justify-content: space-around;
            height: var(--nav-height);
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.7rem;
            gap: 4px;
            width: 60px;
            transition: color 0.2s;
            cursor: pointer;
        }

        .nav-btn i { font-size: 1.25rem; transition: transform 0.2s; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn.active i { transform: translateY(-3px); }

        /* --- Utilities --- */
        .badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }

        /* Toast */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 90%;
            max-width: 350px;
            pointer-events: none;
        }
        .toast {
            background: rgba(15, 23, 36, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: all;
        }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.success { border-left: 4px solid var(--success); }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--bg-body); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 15px;
        }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loader">
        <i class="fa-solid fa-gem fa-spin" style="font-size: 3rem; color: var(--primary);"></i>
        <div style="font-family:'Rajdhani'">CONNECTING TO ROYAL...</div>
    </div>

    <div class="bg-blob"></div>

    <header>
        <div class="profile-header" onclick="app.nav('settings', null)">
            <img src="https://picsum.photos/seed/user/100/100" id="header-pic" class="profile-pic" alt="Profile">
            <div class="profile-info">
                <h2 id="header-name">Guest</h2>
                <span>ID: <span id="header-id">...</span></span>
            </div>
        </div>
        <div class="balance-pill">
            <i class="fa-regular fa-gem" style="color:var(--primary); font-size:0.9rem;"></i>
            <span class="balance-amount" id="global-balance">0</span>
        </div>
    </header>

    <div id="toast-container"></div>

    <main>
        
        <!-- === HOME SECTION === -->
        <div id="home-view" class="tab-view active">
            <h2>Games</h2>
            <div class="games-grid">
                <div class="game-card" onclick="gameManager.selectGame('mines', this)">
                    <div class="game-icon"><i class="fa-solid fa-bomb"></i></div>
                    <div class="game-name">Mines</div>
                </div>
                <div class="game-card" onclick="gameManager.selectGame('dragon-tower', this)">
                    <div class="game-icon"><i class="fa-brands fa-fort-awesome"></i></div>
                    <div class="game-name">Dragon Tower</div>
                </div>
                <div class="game-card" onclick="gameManager.selectGame('dice', this)">
                    <div class="game-icon"><i class="fa-solid fa-dice-d20"></i></div>
                    <div class="game-name">Dice</div>
                </div>
                <div class="game-card" onclick="gameManager.selectGame('limbo', this)">
                    <div class="game-icon"><i class="fa-solid fa-infinity"></i></div>
                    <div class="game-name">Limbo</div>
                </div>
                <div class="game-card" onclick="gameManager.selectGame('dragon-tiger', this)">
                    <div class="game-icon"><i class="fa-solid fa-dragon"></i></div>
                    <div class="game-name">Dragon Tiger</div>
                </div>
                <div class="game-card" onclick="gameManager.selectGame('plinko', this)">
                    <div class="game-icon"><i class="fa-solid fa-arrow-down-short-wide"></i></div>
                    <div class="game-name">Plinko</div>
                </div>
            </div>

            <!-- Dynamic Game Container -->
            <div id="game-stage">
                <div class="game-header">
                    <h3 id="game-title" style="margin:0; font-family:'Rajdhani'; color:var(--primary);">GAME NAME</h3>
                    <button class="close-btn" onclick="gameManager.closeGame()"><i class="fa-solid fa-xmark"></i></button>
                </div>

                <!-- Game Visualization Area -->
                <div id="game-visual" class="game-visual">
                    <!-- Injected via JS -->
                </div>

                <!-- Status Text -->
                <div id="game-status" style="text-align:center; min-height:24px; font-size:0.9rem; margin-bottom:10px; color:var(--text-muted);"></div>

                <!-- Controls -->
                <div class="bet-controls">
                    <input type="number" id="bet-input" class="bet-input" value="20" min="20">
                    <button class="btn btn-secondary" onclick="gameManager.halfBet()">1/2</button>
                </div>
                <button id="action-btn" class="btn btn-primary" onclick="gameManager.handleAction()">BET</button>
            </div>
        </div>

        <!-- === RANKING SECTION === -->
        <div id="ranking-view" class="tab-view">
            <h2>Leaderboard</h2>
            <div class="card">
                <div id="ranking-list" style="padding: 0 10px;">
                    <!-- Populated by JS -->
                    <div style="text-align:center; color:var(--text-muted); padding:20px;">Loading rankings...</div>
                </div>
            </div>
        </div>

        <!-- === WALLET SECTION === -->
        <div id="wallet-view" class="tab-view">
            <h2>Wallet</h2>
            
            <div class="wallet-stats">
                <div class="w-stat">
                    <small>Balance</small>
                    <div style="color:var(--primary)" id="wallet-balance">0</div>
                </div>
                <div class="w-stat">
                    <small>Total Wagered</small>
                    <div style="color:var(--secondary)" id="total-wagered">0</div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <button class="btn btn-secondary" onclick="app.deposit()"><i class="fa-solid fa-arrow-down"></i> Recharge</button>
                <button class="btn btn-secondary" onclick="app.withdraw()"><i class="fa-solid fa-arrow-up"></i> Withdraw</button>
            </div>

            <h3>Recent Activity</h3>
            <div class="card" style="padding: 0 16px;">
                <div id="transaction-list">
                    <!-- JS Populated -->
                </div>
            </div>
        </div>

        <!-- === FRIENDS SECTION === -->
        <div id="friends-view" class="tab-view">
            <h2>Invite Friends</h2>
            <div class="card invite-card">
                <i class="fa-solid fa-gift" style="font-size:3rem; color:var(--primary); margin-bottom:15px; filter:drop-shadow(0 0 10px rgba(251,191,36,0.4));"></i>
                <h3>Get 10% Commission</h3>
                <p style="color:var(--text-muted); font-size:0.9rem; margin:10px 0;">Earn 10% of every friend's deposit directly to your balance.</p>
                
                <div class="ref-box" id="ref-link">https://monarch-play.vercel.app/?ref=ID</div>
                <button class="btn btn-primary" onclick="app.copyRef()">Copy Link</button>
            </div>

            <h3>Your Team</h3>
            <div class="card">
                <div id="referral-list">
                    <div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.9rem;">No friends joined yet.</div>
                </div>
            </div>
        </div>

        <!-- === TASKS SECTION === -->
        <div id="tasks-view" class="tab-view">
            <h2>Daily Tasks</h2>
            <div id="task-list">
                <!-- Populated via JS -->
            </div>
        </div>

        <!-- === SETTINGS SECTION === -->
        <div id="settings-view" class="tab-view">
            <h2>Settings</h2>
            <div class="settings-list">
                <div class="setting-item">
                    <div class="setting-left">
                        <i class="fa-solid fa-wallet" style="color:var(--primary)"></i>
                        <span>Connect TON Wallet</span>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color:var(--text-muted)"></i>
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <i class="fa-solid fa-bell" style="color:var(--secondary)"></i>
                        <span>Notifications</span>
                    </div>
                    <i class="fa-solid fa-toggle-on" style="color:var(--success); font-size:1.5rem;"></i>
                </div>
                <div class="setting-item">
                    <div class="setting-left">
                        <i class="fa-solid fa-circle-info" style="color:var(--text-muted)"></i>
                        <span>About</span>
                    </div>
                    <span style="font-size:0.8rem; color:var(--text-muted)">v1.0</span>
                </div>
                
                <!-- Secret Admin Entry -->
                <div class="setting-item" onclick="adminPanel.login()" style="margin-top:20px; border: 1px solid rgba(255,255,255,0.1);">
                    <div class="setting-left">
                        <i class="fa-solid fa-lock" style="color:var(--danger)"></i>
                        <span>Admin Panel</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- === ADMIN PANEL SECTION === -->
        <div id="admin-view" class="tab-view">
            <div class="game-header">
                <h3 style="margin:0; color:var(--primary);">ADMIN DASHBOARD</h3>
                <button class="close-btn" onclick="app.nav('home', null)"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="admin-dashboard">
                <div class="admin-stat-grid">
                    <div class="w-stat">
                        <small>Total Users</small>
                        <div id="admin-total-users" style="color:var(--primary)">0</div>
                    </div>
                    <div class="w-stat">
                        <small>Online (Simulated)</small>
                        <div id="admin-online-users" style="color:var(--success)">0</div>
                    </div>
                </div>

                <div style="margin-bottom:20px;">
                    <h3>Game Win Rate (%)</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="admin-winrate" class="bet-input" value="50">
                        <button class="btn btn-primary" onclick="adminPanel.updateWinRate()">Update</button>
                    </div>
                </div>

                <h3>User Management</h3>
                <div class="card">
                    <div class="admin-table-container">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Bal</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admin-user-list">
                                <!-- Populated JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <h3>Add Task</h3>
                <div class="card">
                    <input type="text" id="admin-task-name" class="bet-input" placeholder="Task Name" style="margin-bottom:10px;">
                    <input type="text" id="admin-task-link" class="bet-input" placeholder="Link URL" style="margin-bottom:10px;">
                    <input type="number" id="admin-task-reward" class="bet-input" placeholder="Reward" style="margin-bottom:10px;">
                    <button class="btn btn-primary" onclick="adminPanel.addTask()">Publish Task</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Navigation -->
    <nav id="main-nav">
        <div class="nav-bar">
            <div class="nav-btn active" onclick="app.nav('home', this)">
                <i class="fa-solid fa-house"></i>
                <span>Home</span>
            </div>
            <div class="nav-btn" onclick="app.nav('ranking', this)">
                <i class="fa-solid fa-trophy"></i>
                <span>Ranking</span>
            </div>
            <div class="nav-btn" onclick="app.nav('wallet', this)">
                <i class="fa-solid fa-wallet"></i>
                <span>Wallet</span>
            </div>
            <div class="nav-btn" onclick="app.nav('friends', this)">
                <i class="fa-solid fa-user-group"></i>
                <span>Friends</span>
            </div>
            <div class="nav-btn" onclick="app.nav('tasks', this)">
                <i class="fa-solid fa-list-check"></i>
                <span>Tasks</span>
            </div>
        </div>
    </nav>

    <script>
        // --- 1. FIREBASE & TELEGRAM INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyBD8tW5sHlSze2E4E-EjXSjx9eMBdnneQ4",
            authDomain: "free-money-9b371.firebaseapp.com",
            databaseURL: "https://free-money-9b371-default-rtdb.firebaseio.com",
            projectId: "free-money-9b371",
            storageBucket: "free-money-9b371.firebasestorage.app",
            messagingSenderId: "331937781056",
            appId: "1:331937781056:web:ab7fdba321b4053be7d6a5",
            measurementId: "G-ZGC6B44FDV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); // Expand to full height

        // User Data Object
        let currentUser = {
            id: 0,
            name: 'Guest',
            photo: '',
            balance: 1000,
            wagered: 0,
            referredBy: null,
            isBanned: false
        };

        // --- 2. CORE APPLICATION LOGIC ---
        const app = {
            state: {
                transactions: [],
                winRate: 50, // Default global win rate
                tasks: []
            },

            init: async function() {
                // 1. Fetch Telegram User Data
                const tgUser = tg.initDataUnsafe.user;
                
                if (tgUser) {
                    currentUser.id = tgUser.id;
                    currentUser.name = tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : '');
                    currentUser.photo = tgUser.photo_url || `https://ui-avatars.com/api/?name=${currentUser.name}&background=random`;
                } else {
                    // Fallback for testing on desktop
                    currentUser.id = 999999;
                    currentUser.name = "Desktop User";
                    currentUser.photo = "https://ui-avatars.com/api/?name=Desktop+User&background=random";
                }

                // Check URL params for referral
                const urlParams = new URLSearchParams(window.location.search);
                const referrerId = urlParams.get('ref');
                if (referrerId && parseInt(referrerId) !== currentUser.id) {
                    currentUser.referredBy = parseInt(referrerId);
                }

                // 2. Load or Create User in Firestore
                await this.loadUserData();
                
                // 3. Update UI
                this.updateUI();
                
                // 4. Load Global Data
                await this.loadGlobalData();

                // 5. Remove Loader
                document.getElementById('loader').style.display = 'none';
            },

            loadUserData: async function() {
                const userRef = db.collection('users').doc(currentUser.id.toString());
                const doc = await userRef.get();

                if (!doc.exists) {
                    // New User
                    const newUser = {
                        id: currentUser.id,
                        name: currentUser.name,
                        photo: currentUser.photo,
                        balance: 1000,
                        wagered: 0,
                        referredBy: currentUser.referredBy,
                        isBanned: false,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await userRef.set(newUser);
                    currentUser = { ...currentUser, ...newUser };
                    
                    // Handle Referral Logic
                    if (currentUser.referredBy) {
                        const referrerRef = db.collection('users').doc(currentUser.referredBy.toString());
                        // In a real app, you'd increment a referral count here
                        db.runTransaction(t => t.get(referrerRef).then(doc => {
                            // Logic to reward referrer if needed
                        }));
                    }
                } else {
                    // Existing User
                    const data = doc.data();
                    if (data.isBanned) {
                        alert("You are banned from the casino.");
                        return;
                    }
                    currentUser = { ...currentUser, ...data };
                    // Update last seen
                    userRef.update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
                }
            },

            loadGlobalData: async function() {
                // Load Tasks
                const tasksSnapshot = await db.collection('tasks').get();
                this.state.tasks = tasksSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                this.renderTasks();

                // Load Config (Win Rate)
                const configDoc = await db.collection('config').doc('global').get();
                if (configDoc.exists) {
                    this.state.winRate = configDoc.data().winRate || 50;
                }
            },

            updateUI: function() {
                // Header
                document.getElementById('header-name').innerText = currentUser.name;
                document.getElementById('header-id').innerText = currentUser.id;
                document.getElementById('header-pic').src = currentUser.photo;
                
                // Balance
                this.updateBalance(0); // Refresh display only
                
                // Ref Link
                const baseUrl = "https://monarch-play.vercel.app/";
                document.getElementById('ref-link').innerText = `${baseUrl}?ref=${currentUser.id}`;
            },

            updateBalance: async function(amount, type = 'adjust') {
                // Optimistic UI update
                currentUser.balance += amount;
                
                const fmt = new Intl.NumberFormat().format(currentUser.balance);
                document.getElementById('global-balance').innerText = fmt;
                document.getElementById('wallet-balance').innerText = fmt;

                // Sync to Firestore
                if (type !== 'adjust') {
                    try {
                        await db.collection('users').doc(currentUser.id.toString()).update({
                            balance: currentUser.balance,
                            wagered: firebase.firestore.FieldValue.increment(amount > 0 ? 0 : amount) // Only count bets towards wagered
                        });
                        this.logTransaction(type, amount);
                        if(type === 'win') this.showToast(`You won ${amount} Diamonds!`, 'success');
                    } catch (e) {
                        console.error("Balance sync failed", e);
                        this.showToast("Sync error. Refreshing...", 'error');
                        setTimeout(() => location.reload(), 2000);
                    }
                }
            },

            logTransaction: function(type, amount) {
                const tx = { type, amount, date: new Date() };
                this.state.transactions.unshift(tx);
                this.renderTransactions();
                this.renderRanking();
            },

            showToast: function(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                let icon = 'fa-info-circle';
                if(type === 'success') icon = 'fa-check-circle';
                if(type === 'error') icon = 'fa-circle-exclamation';

                toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span>${msg}</span>`;
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            nav: function(viewId, el) {
                // Hide all views
                document.querySelectorAll('.tab-view').forEach(v => v.classList.remove('active'));
                
                // Show target view
                const target = document.getElementById(viewId + '-view');
                if(target) target.classList.add('active');

                // Handle Nav Styling
                if (el) {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    el.classList.add('active');
                }
                
                // Hide/Show Bottom Nav based on view
                const nav = document.getElementById('main-nav');
                if (viewId === 'admin') {
                    nav.style.display = 'none';
                    adminPanel.loadUsers(); // Refresh admin data
                } else {
                    nav.style.display = 'block';
                }

                // Refresh specific views
                if(viewId === 'ranking') this.renderRanking();
                if(viewId === 'friends') this.loadReferrals();
            },

            deposit: function() {
                // Simulate payment gateway
                const btn = event.currentTarget;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
                setTimeout(() => {
                    this.updateBalance(500, 'deposit');
                    this.showToast('Recharge Successful!', 'success');
                    btn.innerHTML = originalText;
                }, 1500);
            },

            withdraw: function() {
                if(currentUser.balance < 1000) {
                    this.showToast('Minimum withdrawal is 1000 Diamonds', 'error');
                    return;
                }
                this.updateBalance(-1000, 'withdraw');
                this.showToast('Withdrawal request sent.', 'success');
            },

            copyRef: function() {
                const code = document.getElementById('ref-link').innerText;
                navigator.clipboard.writeText(code);
                this.showToast('Referral link copied!', 'success');
            },

            loadReferrals: async function() {
                // Query users where referredBy == currentUser.id
                const snapshot = await db.collection('users').where('referredBy', '==', currentUser.id).limit(5).get();
                const list = document.getElementById('referral-list');
                
                if (snapshot.empty) {
                    list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.9rem;">No friends joined yet.</div>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const u = doc.data();
                    html += `
                        <div class="rank-row">
                            <div class="rank-avatar">
                                <img src="${u.photo}" />
                            </div>
                            <div class="rank-info">
                                <div class="rank-name">${u.name}</div>
                                <small style="color:var(--text-muted)">Joined</small>
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            },

            renderRanking: async function() {
                const list = document.getElementById('ranking-list');
                list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">Loading...</div>';
                
                // Query top 10 by balance
                const snapshot = await db.collection('users').orderBy('balance', 'desc').limit(10).get();
                
                let html = '';
                snapshot.forEach(doc => {
                    const u = doc.data();
                    const isMe = u.id === currentUser.id;
                    html += `
                        <div class="rank-row" style="${isMe ? 'background:rgba(251,191,36,0.05)' : ''}">
                            <div class="rank-num">${isMe ? 'You' : (snapshot.docs.indexOf(doc) + 1)}</div>
                            <div class="rank-avatar">
                                <img src="${u.photo}" alt="${u.name}">
                            </div>
                            <div class="rank-info">
                                <div class="rank-name">${u.name}</div>
                            </div>
                            <div class="rank-val">${new Intl.NumberFormat().format(u.balance)}</div>
                        </div>
                    `;
                });
                list.innerHTML = html;
            },

            renderTransactions: function() {
                if(this.state.transactions.length === 0) {
                    document.getElementById('transaction-list').innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.9rem;">No recent activity</div>';
                    return;
                }
                const html = this.state.transactions.map(t => {
                    const isPlus = t.type === 'deposit' || t.type === 'win' || t.type === 'task';
                    return `
                    <div class="tx-item">
                        <div class="tx-left">
                            <div class="tx-icon">
                                <i class="fa-solid ${t.type === 'win' ? 'fa-trophy' : 'fa-arrow-right-arrow-left'}"></i>
                            </div>
                            <div>
                                <div style="font-size:0.9rem; font-weight:600; text-transform:capitalize;">${t.type}</div>
                                <div style="font-size:0.75rem; color:var(--text-muted);">${t.date.toLocaleTimeString()}</div>
                            </div>
                        </div>
                        <div class="tx-amount ${isPlus ? 'tx-plus' : 'tx-minus'}">
                            ${isPlus ? '+' : '-'}${t.amount}
                        </div>
                    </div>`;
                }).join('');
                document.getElementById('transaction-list').innerHTML = html;
            },

            renderTasks: function() {
                const html = this.state.tasks.map(t => `
                    <div class="card task-card">
                        <img src="${t.img || 'https://picsum.photos/seed/task/100/100'}" class="task-img" alt="icon">
                        <div class="task-meta">
                            <div class="task-title">${t.name}</div>
                            <div class="task-reward">+${t.reward} Diamonds</div>
                        </div>
                        <a href="${t.link}" target="_blank" class="btn btn-secondary" style="width:auto; padding:8px 16px; font-size:0.8rem;" onclick="app.completeTask(this, '${t.id}', ${t.reward})">Start</a>
                    </div>
                `).join('');
                document.getElementById('task-list').innerHTML = html || '<div style="text-align:center; padding:20px;">No tasks available.</div>';
            },

            completeTask: async function(btn, taskId, reward) {
                btn.innerText = "Checking...";
                // In a real app, verify interaction via backend
                setTimeout(async () => {
                    btn.innerText = "Claimed";
                    btn.disabled = true;
                    btn.style.opacity = "0.5";
                    await this.updateBalance(reward, 'task');
                    this.showToast(`Task completed! +${reward}`, 'success');
                }, 1000);
            }
        };

        // --- 3. ADMIN PANEL LOGIC ---
        const adminPanel = {
            login: function() {
                const pass = prompt("Enter Admin Password:");
                if (pass === "admin") { // Simple client-side check for demo
                    app.nav('admin', null);
                } else {
                    app.showToast("Access Denied", 'error');
                }
            },

            loadUsers: async function() {
                const list = document.getElementById('admin-user-list');
                const totalEl = document.getElementById('admin-total-users');
                const onlineEl = document.getElementById('admin-online-users');
                
                list.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
                
                const snapshot = await db.collection('users').orderBy('balance', 'desc').limit(20).get();
                
                totalEl.innerText = snapshot.size;
                onlineEl.innerText = Math.floor(snapshot.size * 0.8); // Mock online count

                let html = '';
                snapshot.forEach(doc => {
                    const u = doc.data();
                    html += `
                        <tr>
                            <td>${u.id}</td>
                            <td>${u.name.substring(0, 10)}...</td>
                            <td>${u.balance}</td>
                            <td>
                                <span class="action-link" onclick="adminPanel.modBalance(${u.id}, 100)">+100</span>
                                <span class="action-link" onclick="adminPanel.modBalance(${u.id}, -100)">-100</span>
                                <span class="action-link delete" onclick="adminPanel.banUser(${u.id})">Ban</span>
                            </td>
                        </tr>
                    `;
                });
                list.innerHTML = html;
            },

            modBalance: async function(userId, amount) {
                if(confirm(`Adjust balance for ${userId} by ${amount}?`)) {
                    await db.collection('users').doc(userId.toString()).update({
                        balance: firebase.firestore.FieldValue.increment(amount)
                    });
                    this.loadUsers();
                    app.showToast('Balance updated', 'success');
                }
            },

            banUser: async function(userId) {
                if(confirm(`BAN user ${userId}?`)) {
                    await db.collection('users').doc(userId.toString()).update({ isBanned: true });
                    this.loadUsers();
                    app.showToast('User banned', 'success');
                }
            },

            updateWinRate: async function() {
                const rate = parseInt(document.getElementById('admin-winrate').value);
                await db.collection('config').doc('global').set({ winRate: rate }, { merge: true });
                app.state.winRate = rate;
                app.showToast('Win rate updated', 'success');
            },

            addTask: async function() {
                const name = document.getElementById('admin-task-name').value;
                const link = document.getElementById('admin-task-link').value;
                const reward = parseInt(document.getElementById('admin-task-reward').value);

                if (!name || !link || !reward) return app.showToast('Fill all fields', 'error');

                await db.collection('tasks').add({
                    name, link, reward, 
                    img: `https://picsum.photos/seed/${name}/100/100`
                });
                
                app.showToast('Task Added', 'success');
                // Clear inputs
                document.getElementById('admin-task-name').value = '';
                document.getElementById('admin-task-link').value = '';
                document.getElementById('admin-task-reward').value = '';
            }
        };

        // --- 4. GAME MANAGER (Enhanced with Redirect Simulation) ---
        const gameManager = {
            activeGame: null,
            inProgress: false,
            data: {},

            selectGame: function(gameName, el) {
                // "Redirect" Simulation
                // We hide the main views and show a game-only view, 
                // or we keep the current structure but scroll to stage.
                // Based on request "redirect to another page", we use history API.
                
                // But to keep it single file, we just hide the game grid and show full stage.
                document.querySelector('.games-grid').style.display = 'none';
                document.getElementById('game-stage').style.display = 'block';
                document.getElementById('game-stage').scrollIntoView({ behavior: 'smooth', block: 'start' });

                this.activeGame = gameName;
                this.inProgress = false;
                
                document.getElementById('game-title').innerText = gameName.replace('-', ' ').toUpperCase();
                document.getElementById('game-status').innerText = "Place your bet to start";
                document.getElementById('game-status').style.color = "var(--text-muted)";
                
                const btn = document.getElementById('action-btn');
                btn.innerText = "BET";
                btn.className = "btn btn-primary";

                this.initGameVisuals(gameName);
            },

            closeGame: function() {
                // "Go Back" Simulation
                document.getElementById('game-stage').style.display = 'none';
                document.querySelector('.games-grid').style.display = 'grid';
                window.scrollTo({ top: 0, behavior: 'smooth' });
                this.activeGame = null;
            },

            halfBet: function() {
                const input = document.getElementById('bet-input');
                let val = parseInt(input.value);
                if (val > 20) input.value = Math.max(20, Math.floor(val / 2));
            },

            initGameVisuals: function(game) {
                const visual = document.getElementById('game-visual');
                visual.innerHTML = '';

                if (game === 'mines') {
                    this.data.mines = [];
                    this.data.grid = Array(25).fill(null);
                    this.data.multiplier = 1.0;
                    
                    let html = '<div class="mines-board">';
                    for(let i=0; i<25; i++) {
                        html += `<div class="mine-cell" id="m-${i}" onclick="gameManager.minesClick(${i})"></div>`;
                    }
                    html += '</div>';
                    visual.innerHTML = html;
                }
                else if (game === 'dice') {
                    visual.innerHTML = `<div class="dice-circle" id="dice-res">?</div>`;
                }
                else if (game === 'limbo') {
                    visual.innerHTML = `<div style="font-size:3.5rem; font-family:'Rajdhani'; font-weight:700;" id="limbo-res">1.00x</div>`;
                }
                else {
                    visual.innerHTML = `<div style="padding:40px; color:var(--text-muted); text-align:center;">${game.toUpperCase()} Loaded<br>Ready to Bet</div>`;
                }
            },

            handleAction: function() {
                const bet = parseInt(document.getElementById('bet-input').value);
                // Min Bet Check
                if (isNaN(bet) || bet < 20) return app.showToast("Minimum bet is 20 Diamonds", 'error');
                if (bet > currentUser.balance) return app.showToast("Insufficient balance", 'error');

                if (!this.inProgress) {
                    // START GAME
                    this.inProgress = true;
                    app.updateBalance(-bet, 'bet');
                    
                    const btn = document.getElementById('action-btn');
                    btn.innerText = "CASHOUT";
                    btn.className = "btn btn-secondary";

                    document.getElementById('game-status').innerText = "Game Active";
                    document.getElementById('game-status').style.color = "var(--primary)";

                    this.executeGameLogic(bet);
                } else {
                    // CASHOUT
                    this.cashout(bet);
                }
            },

            executeGameLogic: function(bet) {
                const status = document.getElementById('game-status');
                // Global Win Rate Check
                const shouldWin = Math.random() * 100 < app.state.winRate;

                if (this.activeGame === 'mines') {
                    // Place 3 random mines
                    this.data.grid.fill(0);
                    let placed = 0;
                    while(placed < 3) {
                        let r = Math.floor(Math.random()*25);
                        if(this.data.grid[r] === 0) {
                            this.data.grid[r] = 1; // Mine
                            placed++;
                        }
                    }
                    this.data.multiplier = 1.0;
                    this.data.bet = bet;
                    status.innerText = "Pick a gem!";
                }
                else if (this.activeGame === 'dice') {
                    // Simulate roll
                    const roll = Math.floor(Math.random() * 6) + 1;
                    const diceEl = document.getElementById('dice-res');
                    
                    let i = 0;
                    const intv = setInterval(() => {
                        diceEl.innerText = ['','','','','',''][Math.floor(Math.random()*6)];
                        i++;
                        if(i > 10) {
                            clearInterval(intv);
                            diceEl.innerText = ['','','','','',''][roll-1];
                            
                            // Logic: > 3 wins
                            const win = (roll > 3 && shouldWin) || (roll > 3 && !shouldWin); // Simplified
                            const realWin = roll > 3; // Standard dice rule

                            if (realWin) {
                                app.updateBalance(bet * 2, 'win');
                                status.innerText = `Rolled ${roll} - YOU WON!`;
                                status.style.color = "var(--success)";
                            } else {
                                status.innerText = `Rolled ${roll} - YOU LOST`;
                                status.style.color = "var(--danger)";
                            }
                            this.resetBtn();
                        }
                    }, 50);
                }
                else {
                    // Generic logic for other games
                    setTimeout(() => {
                        if (shouldWin) {
                            const mult = Math.floor(Math.random() * 2) + 1.5;
                            app.updateBalance(Math.floor(bet * mult), 'win');
                            status.innerText = `YOU WON ${mult}x!`;
                            status.style.color = "var(--success)";
                        } else {
                            status.innerText = "YOU LOST";
                            status.style.color = "var(--danger)";
                        }
                        this.resetBtn();
                    }, 1000);
                }
            },

            minesClick: function(index) {
                if(!this.inProgress || this.data.grid[index] !== null) return;

                const cell = document.getElementById(`m-${index}`);
                const isMine = this.data.grid[index] === 1;

                if (isMine) {
                    cell.classList.add('boom');
                    cell.innerHTML = '<i class="fa-solid fa-bomb"></i>';
                    document.getElementById('game-status').innerText = "BOOM! Game Over.";
                    document.getElementById('game-status').style.color = "var(--danger)";
                    this.resetBtn();
                } else {
                    cell.classList.add('safe');
                    cell.innerHTML = '<i class="fa-regular fa-gem"></i>';
                    this.data.grid[index] = 2; // revealed safe
                    this.data.multiplier += 0.2; // Simple increment
                    document.getElementById('game-status').innerText = `Multiplier: ${this.data.multiplier.toFixed(2)}x | Cashout?`;
                }
            },

            cashout: function(bet) {
                if (this.activeGame === 'mines') {
                    if (this.data.multiplier > 1) {
                        app.updateBalance(Math.floor(this.data.bet * this.data.multiplier), 'win');
                        document.getElementById('game-status').innerText = "Cashed out successfully!";
                        document.getElementById('game-status').style.color = "var(--success)";
                    } else {
                        app.showToast("Reveal a gem first!", 'error');
                        return;
                    }
                }
                this.resetBtn();
            },

            resetBtn: function() {
                this.inProgress = false;
                const btn = document.getElementById('action-btn');
                btn.innerText = "BET";
                btn.className = "btn btn-primary";
            }
        };

        // Start App
        window.onload = function() {
            app.init();
        };

    </script>
</body>
</html>
