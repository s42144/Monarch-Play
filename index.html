<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Royal Diamond Casino</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, push, child, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBD8tW5sHlSze2E4E-EjXSjx9eMBdnneQ4",
            authDomain: "free-money-9b371.firebaseapp.com",
            databaseURL: "https://free-money-9b371-default-rtdb.firebaseio.com",
            projectId: "free-money-9b371",
            storageBucket: "free-money-9b371.firebasestorage.app",
            messagingSenderId: "331937781056",
            appId: "1:331937781056:web:ab7fdba321b4053be7d6a5",
            measurementId: "G-ZGC6B44FDV"
        };

        // Initialize Firebase
        const fbApp = initializeApp(firebaseConfig);
        const db = getDatabase(fbApp);
        const analytics = getAnalytics(fbApp);

        // --- TELEGRAM BOT API ---
        const BOT_TOKEN = "8583171793:AAEg649kmH347L4Y6bfVKaDmb5d_r2yn6vw";
        // NOTE: In a real app, never expose BOT_TOKEN on client side. 
        // Send requests through your own backend server.

        // Make functions global for the main script
        window.fbDB = db;
        window.fbRef = ref;
        window.fbSet = set;
        window.fbGet = get;
        window.fbUpdate = update;
        window.fbPush = push;
        window.fbChild = child;
        window.fbOnValue = onValue;
        window.fbRemove = remove;
        
        window.sendTelegramNotification = async (text, chatId = '331937781056') => { // Defaulting to admin ID from config for notifications
            try {
                const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chat_id: chatId, text: text })
                });
            } catch (e) { console.error("Telegram API Error:", e); }
        };
    </script>

    <style>
        :root {
            --bg-body: #050b14;
            --bg-surface: #0f1724;
            --bg-card: #162030;
            --bg-glass: rgba(22, 32, 48, 0.9);
            
            --primary: #fbbf24; /* Gold */
            --primary-glow: rgba(251, 191, 36, 0.3);
            --secondary: #38bdf8; /* Cyan */
            --accent: #f43f5e;
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            --success: #10b981;
            --danger: #ef4444;
            
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            
            --safe-area-bottom: env(safe-area-inset-bottom);
            --nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Background --- */
        .bg-blob {
            position: absolute; width: 350px; height: 350px;
            background: radial-gradient(circle, var(--primary-glow) 0%, transparent 70%);
            top: -120px; left: 50%; transform: translateX(-50%);
            z-index: 0; pointer-events: none;
        }

        /* --- Header --- */
        header {
            z-index: 10; padding: 10px 16px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(5,11,20,0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .brand { display: flex; align-items: center; gap: 8px; font-family: 'Rajdhani', sans-serif; font-weight: 700; color: var(--text-main); }
        .brand i { color: var(--primary); }

        .user-pill {
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 4px 4px 4px;
            border-radius: 50px;
            display: flex; align-items: center; gap: 8px;
            cursor: pointer; transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .user-pill:active { background: rgba(255,255,255,0.1); }
        
        .user-avatar {
            width: 32px; height: 32px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--primary);
        }
        .user-name { font-size: 0.9rem; font-weight: 600; padding-right: 8px; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .balance-display {
            text-align: right;
        }
        .balance-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        .balance-val { font-family: 'Rajdhani'; font-size: 1.1rem; font-weight: 700; color: var(--primary); }

        /* --- Layout --- */
        main {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            position: relative; z-index: 1;
            padding: 16px 16px calc(var(--nav-height) + 20px) 16px;
        }
        main::-webkit-scrollbar { display: none; }

        .tab-view { display: none; animation: slideUp 0.3s ease; }
        .tab-view.active { display: block; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { font-family: 'Rajdhani'; font-size: 1.4rem; margin: 10px 0 16px 0; color: var(--text-main); }

        /* --- Cards & Buttons --- */
        .card { background: var(--bg-card); border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.03); }
        
        .btn {
            width: 100%; padding: 12px; border-radius: var(--radius-md); border: none;
            font-weight: 600; font-size: 0.95rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #d97706); color: #000; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: var(--text-main); }
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }

        /* --- Game Grid --- */
        .games-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .game-card {
            background: var(--bg-surface); border-radius: var(--radius-md);
            padding: 24px 10px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; cursor: pointer;
        }
        .game-card:active { transform: scale(0.96); background: var(--bg-card); }
        .game-icon {
            width: 56px; height: 56px; border-radius: 50%;
            background: rgba(255,255,255,0.05); display: flex;
            align-items: center; justify-content: center; font-size: 1.5rem;
            margin-bottom: 12px; color: var(--text-main);
        }
        .game-name { font-weight: 600; font-size: 0.95rem; }

        /* --- Full Screen Game Page --- */
        #game-fullscreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 100;
            display: none; flex-direction: column;
        }
        #game-fullscreen.active { display: flex; }
        
        .game-nav {
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .game-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .game-controls-area {
            background: var(--bg-surface); width: 100%; padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Specific Game Styles --- */
        .mines-board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; width: 100%; max-width: 350px; }
        .mine-cell {
            aspect-ratio: 1; background: rgba(0,0,0,0.3); border-radius: 6px;
            display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.05); transition: 0.2s;
        }
        .mine-cell.revealed { background: var(--bg-card); border-color: rgba(255,255,255,0.1); }
        .mine-cell.gem { background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success); }
        .mine-cell.boom { background: var(--danger); color: white; animation: shake 0.4s; }
        
        .dice-display { font-size: 5rem; margin: 40px 0; text-shadow: 0 0 20px rgba(255,255,255,0.1); }

        /* --- Leaderboard --- */
        .rank-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-pos { width: 30px; font-weight: 700; color: var(--text-muted); font-family: 'Rajdhani'; }
        .rank-1 { color: #ffd700; } .rank-2 { color: #c0c0c0; } .rank-3 { color: #cd7f32; }
        .rank-avatar { width: 36px; height: 36px; border-radius: 50%; margin-right: 12px; background: #333; }
        .rank-details { flex: 1; }
        .rank-name { font-weight: 600; font-size: 0.9rem; }
        .rank-score { font-family: 'Rajdhani'; color: var(--primary); font-weight: 700; }

        /* --- Friends --- */
        .ref-link-box {
            background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px;
            font-family: monospace; text-align: center; border: 1px dashed var(--secondary); margin: 15px 0;
        }
        .monarch-link {
            display: block; margin-top: 20px; padding: 15px;
            background: linear-gradient(90deg, #222, #333); border-radius: 8px;
            text-decoration: none; color: var(--primary); font-weight: 600; text-align: center;
            border: 1px solid var(--primary);
        }

        /* --- Admin Panel --- */
        #admin-panel { display: none; padding-bottom: 80px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--bg-surface); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-num { font-size: 1.2rem; font-weight: 700; color: var(--primary); font-family: 'Rajdhani'; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .input-group input, .input-group select {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 10px; border-radius: 6px;
        }

        /* --- Navigation --- */
        nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(5, 11, 20, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-bottom: var(--safe-area-bottom); z-index: 50;
        }
        .nav-bar { display: flex; justify-content: space-around; height: var(--nav-height); }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 0.7rem; gap: 4px; width: 60px; cursor: pointer;
        }
        .nav-btn i { font-size: 1.2rem; transition: 0.2s; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn.active i { transform: translateY(-2px); }

        /* --- Modal --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200; display: none;
            align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-card); width: 90%; max-width: 350px;
            padding: 20px; border-radius: var(--radius-lg); position: relative;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-muted); font-size: 1.2rem; }

        /* --- Toast --- */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 300; width: 90%; pointer-events: none; }
        .toast {
            background: rgba(15, 23, 36, 0.95); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 12px 16px; border-radius: 12px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px; animation: slideDown 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); pointer-events: all;
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

    </style>
</head>
<body>

    <div class="bg-blob"></div>

    <!-- Main Header -->
    <header>
        <div class="brand">
            <i class="fa-solid fa-gem"></i>
            <span>ROYAL</span>
        </div>
        <div class="user-pill" onclick="app.toggleProfile()">
            <img src="" id="header-avatar" class="user-avatar" alt="User">
            <div class="user-name" id="header-name">Loading...</div>
            <div class="balance-display">
                <div class="balance-label">Balance</div>
                <div class="balance-val" id="header-balance">0</div>
            </div>
        </div>
    </header>

    <div id="toast-container"></div>

    <main>
        <!-- HOME TAB -->
        <div id="home-view" class="tab-view active">
            <h2>Games</h2>
            <div class="games-grid">
                <div class="game-card" onclick="gameManager.openGame('mines')">
                    <div class="game-icon"><i class="fa-solid fa-bomb"></i></div>
                    <div class="game-name">Mines</div>
                </div>
                <div class="game-card" onclick="gameManager.openGame('dragon-tower')">
                    <div class="game-icon"><i class="fa-brands fa-fort-awesome"></i></div>
                    <div class="game-name">Dragon Tower</div>
                </div>
                <div class="game-card" onclick="gameManager.openGame('dice')">
                    <div class="game-icon"><i class="fa-solid fa-dice-d20"></i></div>
                    <div class="game-name">Dice</div>
                </div>
                <div class="game-card" onclick="gameManager.openGame('limbo')">
                    <div class="game-icon"><i class="fa-solid fa-infinity"></i></div>
                    <div class="game-name">Limbo</div>
                </div>
            </div>

            <!-- Recent Games (Mockup for UI) -->
            <h2>Live Activity</h2>
            <div class="card" id="live-feed" style="padding:10px; font-size:0.85rem; color:var(--text-muted);">
                <!-- Populated via JS -->
            </div>
        </div>

        <!-- RANKING TAB -->
        <div id="ranking-view" class="tab-view">
            <h2>Top Players</h2>
            <div class="card" style="padding:0;">
                <div id="ranking-list">
                    <div style="padding:20px; text-align:center;">Loading ranking...</div>
                </div>
            </div>
        </div>

        <!-- WALLET TAB -->
        <div id="wallet-view" class="tab-view">
            <h2>Wallet</h2>
            <div class="card" style="text-align:center; padding:30px;">
                <div style="font-size:0.9rem; color:var(--text-muted)">Total Balance</div>
                <div style="font-size:3rem; font-family:'Rajdhani'; font-weight:700; color:var(--primary);" id="wallet-balance-big">0</div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <button class="btn btn-primary" onclick="app.showToast('Deposit Gateway Opening...', 'info')"><i class="fa-solid fa-plus"></i> Deposit</button>
                <button class="btn btn-secondary" onclick="app.showToast('Withdrawal Request Sent', 'success')"><i class="fa-solid fa-arrow-right-from-bracket"></i> Withdraw</button>
            </div>

            <h3>Transaction History</h3>
            <div class="card" id="tx-history">
                <div style="padding:10px; text-align:center; color:var(--text-muted)">No transactions yet</div>
            </div>
        </div>

        <!-- FRIENDS TAB -->
        <div id="friends-view" class="tab-view">
            <h2>Invite Friends</h2>
            <div class="card" style="text-align:center;">
                <i class="fa-solid fa-users-gear" style="font-size:2.5rem; color:var(--primary); margin-bottom:15px;"></i>
                <h3> Earn 10% Commission</h3>
                <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:15px;">Invite friends and earn 10% of their deposits.</p>
                
                <div class="ref-link-box" id="my-ref-link">...</div>
                <button class="btn btn-primary" onclick="app.copyRef()">Copy Referral Link</button>

                <a href="https://monarch-play.vercel.app/" target="_blank" class="monarch-link">
                    <i class="fa-solid fa-external-link-alt"></i> Visit Monarch Play
                </a>
            </div>
        </div>

        <!-- TASKS TAB -->
        <div id="tasks-view" class="tab-view">
            <h2>Daily Tasks</h2>
            <div id="task-list">
                <!-- Fetched from Firebase -->
            </div>
        </div>

        <!-- ADMIN PANEL (Hidden unless Admin) -->
        <div id="admin-view" class="tab-view">
            <h2>Admin Dashboard</h2>
            <div class="stat-grid">
                <div class="stat-box">
                    <div style="font-size:0.8rem; color:var(--text-muted)">Total Users</div>
                    <div class="stat-num" id="admin-total-users">0</div>
                </div>
                <div class="stat-box">
                    <div style="font-size:0.8rem; color:var(--text-muted)">Online</div>
                    <div class="stat-num" id="admin-online">0</div>
                </div>
            </div>

            <div class="card">
                <h3>Game Controls</h3>
                <div class="input-group">
                    <label>Global Win Rate (%)</label>
                    <input type="range" min="0" max="100" value="50" id="admin-winrate" oninput="document.getElementById('wr-val').innerText = this.value + '%'">
                    <div style="text-align:right; color:var(--primary); font-weight:bold;" id="wr-val">50%</div>
                </div>
                <button class="btn btn-primary" onclick="admin.saveSettings()">Update Settings</button>
            </div>

            <div class="card">
                <h3>User Management</h3>
                <div class="input-group">
                    <input type="number" id="admin-search-id" placeholder="Enter User Telegram ID">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <button class="btn btn-secondary" onclick="admin.searchUser()">Search</button>
                    <button class="btn btn-danger" onclick="admin.banUser()">Ban User</button>
                </div>
                <div class="input-group">
                    <label>Adjust Balance</label>
                    <input type="number" id="admin-balance-adj" placeholder="Amount (e.g. 1000 or -500)">
                </div>
                <button class="btn btn-secondary" onclick="admin.updateBalance()">Update Balance</button>
            </div>

            <div class="card">
                <h3>Add Task</h3>
                <div class="input-group">
                    <input type="text" id="new-task-name" placeholder="Task Name">
                </div>
                <div class="input-group">
                    <input type="text" id="new-task-link" placeholder="Task Link">
                </div>
                <div class="input-group">
                    <input type="number" id="new-task-reward" placeholder="Reward Amount">
                </div>
                <button class="btn btn-primary" onclick="admin.addTask()">Add Task</button>
            </div>
        </div>

    </main>

    <!-- Navigation -->
    <nav>
        <div class="nav-bar">
            <div class="nav-btn active" onclick="app.nav('home', this)">
                <i class="fa-solid fa-house"></i>
                <span>Home</span>
            </div>
            <div class="nav-btn" onclick="app.nav('ranking', this)">
                <i class="fa-solid fa-trophy"></i>
                <span>Ranking</span>
            </div>
            <div class="nav-btn" onclick="app.nav('wallet', this)">
                <i class="fa-solid fa-wallet"></i>
                <span>Wallet</span>
            </div>
            <div class="nav-btn" onclick="app.nav('friends', this)">
                <i class="fa-solid fa-user-group"></i>
                <span>Friends</span>
            </div>
            <div class="nav-btn" onclick="app.nav('tasks', this)">
                <i class="fa-solid fa-list-check"></i>
                <span>Tasks</span>
            </div>
        </div>
    </nav>

    <!-- Profile Settings Modal -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="app.toggleProfile()"><i class="fa-solid fa-xmark"></i></button>
            <h2 style="margin-top:0;">Settings</h2>
            <div style="text-align:center; margin-bottom:20px;">
                <img id="modal-avatar" src="" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--primary); margin-bottom:10px;">
                <h3 id="modal-name">User Name</h3>
                <div style="font-family:monospace; color:var(--text-muted); font-size:0.8rem;">ID: <span id="modal-id"></span></div>
            </div>

            <button class="btn btn-secondary" style="margin-bottom:10px;" onclick="app.connectTon()">
                <i class="fa-brands fa-telegram"></i> Connect TON Wallet
            </button>
            <button class="btn btn-danger" onclick="app.logout()">Log Out</button>
        </div>
    </div>

    <!-- Full Screen Game Overlay -->
    <div id="game-fullscreen">
        <div class="game-nav">
            <button class="btn btn-secondary" style="width:auto; padding:8px 16px;" onclick="gameManager.closeGame()">
                <i class="fa-solid fa-arrow-left"></i> Back
            </button>
            <div style="text-align:right;">
                <div style="font-size:0.7rem; color:var(--text-muted);">Bet</div>
                <div id="game-bet-display" style="font-family:'Rajdhani'; font-weight:700; color:var(--primary);">100</div>
            </div>
        </div>
        
        <div class="game-content" id="game-visual-container">
            <!-- Game Canvas/Visuals injected here -->
        </div>

        <div class="game-controls-area">
            <div id="game-status" style="text-align:center; margin-bottom:15px; min-height:20px; font-size:0.9rem;">Place your bet</div>
            
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn btn-secondary" onclick="gameManager.adjustBet(-0.5)">1/2</button>
                <button class="btn btn-secondary" onclick="gameManager.adjustBet(2)">x2</button>
            </div>

            <input type="range" min="10" max="5000" step="10" value="100" id="bet-slider" style="width:100%; margin-bottom:15px;" oninput="gameManager.updateBetDisplay(this.value)">

            <button id="game-action-btn" class="btn btn-primary" onclick="gameManager.handleAction()">BET</button>
        </div>
    </div>

    <script>
        // --- GLOBAL CONFIG ---
        const ADMIN_ID = "331937781056"; // Replace with your actual Telegram ID if different

        // --- APP STATE ---
        const app = {
            user: null, // { id, first_name, photo_url, username }
            balance: 0,
            currentBet: 100,
            isAdmin: false,
            
            init: async function() {
                // 1. Telegram WebApp Init
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();

                // Get user data or fallback to Guest for desktop testing
                this.user = tg.initDataUnsafe.user || { 
                    id: 999999, 
                    first_name: "Guest User", 
                    username: "guest", 
                    photo_url: "https://picsum.photos/seed/guest/100/100" 
                };

                // 2. Check Admin
                if(this.user.id.toString() === ADMIN_ID) {
                    this.isAdmin = true;
                    this.addAdminNav();
                }

                // 3. Load from Firebase
                await this.loadUserData();
                this.setupListeners();
                this.updateUI();
                
                // 4. Generate Ref Link
                const botName = "RoyalDiamondBot"; // Replace with your bot username
                document.getElementById('my-ref-link').innerText = `https://t.me/${botName}?start=${this.user.id}`;

                // 5. Send "Online" ping
                window.fbSet(window.fbRef(window.fbDB, 'users/' + this.user.id + '/lastOnline'), Date.now());
            },

            loadUserData: async function() {
                const snapshot = await window.fbGet(window.fbRef(window.fbDB, 'users/' + this.user.id));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    this.balance = data.balance || 1000; // Default balance logic
                    if(data.banned) {
                        alert("You have been banned from the casino.");
                        document.body.innerHTML = "<h1 style='text-align:center; color:red; margin-top:50px;'>BANNED</h1>";
                        throw new Error("Banned");
                    }
                } else {
                    // New User
                    this.balance = 1000;
                    await this.saveBalance();
                    
                    // Check referral
                    const urlParams = new URLSearchParams(window.location.search);
                    const referrer = urlParams.get('start');
                    if(referrer) {
                        // Log referral (simplified)
                        console.log("Referred by", referrer);
                        window.fbSet(window.fbRef(window.fbDB, `users/${referrer}/referrals/${this.user.id}`), true);
                    }
                }
            },

            saveBalance: async function() {
                await window.fbUpdate(window.fbRef(window.fbDB, 'users/' + this.user.id), {
                    balance: this.balance,
                    name: this.user.first_name,
                    photo: this.user.photo_url || "",
                    username: this.user.username || "user"
                });
                this.updateUI();
            },

            updateUI: function() {
                // Header
                document.getElementById('header-name').innerText = this.user.first_name;
                document.getElementById('header-avatar').src = this.user.photo_url || `https://picsum.photos/seed/${this.user.id}/100/100`;
                document.getElementById('header-balance').innerText = this.balance.toLocaleString();
                document.getElementById('wallet-balance-big').innerText = this.balance.toLocaleString();

                // Modal
                document.getElementById('modal-name').innerText = this.user.first_name;
                document.getElementById('modal-id').innerText = this.user.id;
                document.getElementById('modal-avatar').src = this.user.photo_url || `https://picsum.photos/seed/${this.user.id}/100/100`;
            },

            nav: function(viewId, el) {
                document.querySelectorAll('.tab-view').forEach(v => v.classList.remove('active'));
                document.getElementById(viewId + '-view').classList.add('active');
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                if(el) el.classList.add('active');

                if(viewId === 'ranking') this.renderRanking();
                if(viewId === 'tasks') this.renderTasks();
            },

            toggleProfile: function() {
                const modal = document.getElementById('profile-modal');
                modal.classList.toggle('active');
            },

            connectTon: function() {
                this.showToast("Opening TON Wallet...", "info");
                // Simulate connection or open deep link
                setTimeout(() => {
                    this.showToast("Wallet Connected (Demo)", "success");
                }, 1000);
            },

            logout: function() {
                this.showToast("Logged Out", "info");
                // Logic to clear session if needed
            },

            copyRef: function() {
                const text = document.getElementById('my-ref-link').innerText;
                navigator.clipboard.writeText(text);
                this.showToast("Referral Link Copied!", "success");
            },

            showToast: function(msg, type) {
                const container = document.getElementById('toast-container');
                const div = document.createElement('div');
                div.className = `toast ${type}`;
                div.innerHTML = `<span>${msg}</span>`;
                container.appendChild(div);
                setTimeout(() => div.remove(), 3000);
            },

            addAdminNav: function() {
                const bar = document.querySelector('.nav-bar');
                const btn = document.createElement('div');
                btn.className = 'nav-btn';
                btn.innerHTML = `<i class="fa-solid fa-user-shield"></i><span>Admin</span>`;
                btn.onclick = () => this.nav('admin', btn);
                bar.appendChild(btn);
                
                // Make admin view visible
                const view = document.getElementById('admin-view');
                view.style.display = 'block'; // It exists but hidden by default CSS logic if needed, handled by tab logic
                
                // Admin Listeners
                window.fbOnValue(window.fbRef(window.fbDB, 'admin/settings'), (snap) => {
                    if(snap.exists()) {
                        document.getElementById('admin-winrate').value = snap.val().winRate || 50;
                        document.getElementById('wr-val').innerText = (snap.val().winRate || 50) + '%';
                    }
                });

                // Count users
                window.fbOnValue(window.fbRef(window.fbDB, 'users'), (snap) => {
                    if(snap.exists()) {
                        const count = Object.keys(snap.val()).length;
                        document.getElementById('admin-total-users').innerText = count;
                    }
                });
            },

            renderRanking: function() {
                window.fbGet(window.fbRef(window.fbDB, 'users')).then((snap) => {
                    if(!snap.exists()) return;
                    const users = [];
                    snap.forEach(c => {
                        users.push(c.val());
                    });
                    // Sort desc balance
                    users.sort((a,b) => (b.balance || 0) - (a.balance || 0));
                    
                    const html = users.slice(0, 50).map((u, i) => `
                        <div class="rank-item">
                            <div class="rank-pos rank-${i+1}">${i+1}</div>
                            <img src="${u.photo || `https://picsum.photos/seed/${u.id}/50/50`}" class="rank-avatar">
                            <div class="rank-details">
                                <div class="rank-name">${u.name || 'Anonymous'}</div>
                            </div>
                            <div class="rank-score">${(u.balance || 0).toLocaleString()}</div>
                        </div>
                    `).join('');
                    document.getElementById('ranking-list').innerHTML = html;
                });
            },

            renderTasks: function() {
                window.fbGet(window.fbRef(window.fbDB, 'tasks')).then((snap) => {
                    if(!snap.exists()) {
                        document.getElementById('task-list').innerHTML = '<div style="padding:20px;text-align:center">No tasks available</div>';
                        return;
                    }
                    let html = '';
                    snap.forEach(c => {
                        const t = c.val();
                        html += `
                        <div class="card" style="display:flex; align-items:center; gap:10px;">
                            <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:8px;">
                                <i class="fa-solid fa-check-circle" style="color:var(--success)"></i>
                            </div>
                            <div style="flex:1">
                                <div style="font-weight:600">${t.name}</div>
                                <div style="font-size:0.8rem; color:var(--primary)">+${t.reward} Coins</div>
                            </div>
                            <button class="btn btn-secondary" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="app.doTask('${c.key}', ${t.reward})">Start</button>
                        </div>`;
                    });
                    document.getElementById('task-list').innerHTML = html;
                });
            },

            doTask: async function(key, reward) {
                // Simple logic: In real app, verify visit
                this.balance += reward;
                await this.saveBalance();
                this.showToast(`Task Completed! +${reward}`, "success");
                // Remove from local view or mark done
                this.renderTasks();
            },

            setupListeners: function() {
                // Live Feed Simulation
                setInterval(() => {
                    const names = ["Alex", "CryptoKing", "Lucky", "Winner99"];
                    const games = ["Mines", "Dice", "Plinko"];
                    const name = names[Math.floor(Math.random()*names.length)];
                    const game = games[Math.floor(Math.random()*games.length)];
                    const amt = Math.floor(Math.random() * 5000) + 100;
                    
                    const div = document.createElement('div');
                    div.style.padding = "5px 0";
                    div.style.borderBottom = "1px solid rgba(255,255,255,0.05)";
                    div.innerHTML = `<span style="color:var(--primary)">${name}</span> won <span style="color:white">${amt}</span> in ${game}`;
                    
                    const feed = document.getElementById('live-feed');
                    feed.prepend(div);
                    if(feed.children.length > 5) feed.lastChild.remove();
                }, 3000);
            }
        };

        // --- ADMIN CONTROLLER ---
        const admin = {
            saveSettings: function() {
                const wr = document.getElementById('admin-winrate').value;
                window.fbSet(window.fbRef(window.fbDB, 'admin/settings'), { winRate: parseInt(wr) });
                app.showToast("Settings Saved", "success");
            },
            
            searchUser: function() {
                const id = document.getElementById('admin-search-id').value;
                window.fbGet(window.fbRef(window.fbDB, 'users/' + id)).then(snap => {
                    if(snap.exists()) {
                        const u = snap.val();
                        alert(`Found: ${u.name}\nBalance: ${u.balance}\nBanned: ${u.banned ? 'Yes' : 'No'}`);
                    } else {
                        app.showToast("User not found", "error");
                    }
                });
            },

            banUser: function() {
                const id = document.getElementById('admin-search-id').value;
                window.fbUpdate(window.fbRef(window.fbDB, 'users/' + id), { banned: true });
                app.showToast("User Banned", "success");
            },

            updateBalance: function() {
                const id = document.getElementById('admin-search-id').value;
                const amt = parseInt(document.getElementById('admin-balance-adj').value);
                if(!id || !amt) return;
                
                window.fbGet(window.fbRef(window.fbDB, 'users/' + id)).then(snap => {
                    if(snap.exists()) {
                        const cur = snap.val().balance || 0;
                        window.fbUpdate(window.fbRef(window.fbDB, 'users/' + id), { balance: cur + amt });
                        app.showToast("Balance Updated", "success");
                    }
                });
            },

            addTask: function() {
                const name = document.getElementById('new-task-name').value;
                const link = document.getElementById('new-task-link').value;
                const reward = document.getElementById('new-task-reward').value;
                
                if(name && link && reward) {
                    window.fbPush(window.fbRef(window.fbDB, 'tasks'), {
                        name, link, reward: parseInt(reward)
                    });
                    app.showToast("Task Added", "success");
                }
            }
        };

        // --- GAME MANAGER (ENHANCED) ---
        const gameManager = {
            activeGame: null,
            isPlaying: false,
            gridState: [], // For mines
            winRate: 50,

            openGame: function(gameName) {
                this.activeGame = gameName;
                this.isPlaying = false;
                document.getElementById('game-fullscreen').classList.add('active');
                document.getElementById('game-action-btn').innerText = "BET";
                document.getElementById('game-action-btn').className = "btn btn-primary";
                document.getElementById('game-status').innerText = "Place your bet and start";
                document.getElementById('game-status').style.color = "var(--text-muted)";
                
                this.renderGameVisuals();
                
                // Fetch Admin Win Rate
                window.fbGet(window.fbRef(window.fbDB, 'admin/settings')).then(s => {
                    if(s.exists() && s.val().winRate) this.winRate = s.val().winRate;
                });
            },

            closeGame: function() {
                document.getElementById('game-fullscreen').classList.remove('active');
                this.activeGame = null;
                app.updateUI(); // Refresh balance in background
            },

            adjustBet: function(factor) {
                let newBet = Math.floor(app.currentBet * factor);
                if(newBet < 10) newBet = 10;
                app.currentBet = newBet;
                this.updateBetDisplay(newBet);
            },

            updateBetDisplay: function(val) {
                app.currentBet = parseInt(val);
                document.getElementById('bet-slider').value = val;
                document.getElementById('game-bet-display').innerText = val;
            },

            renderGameVisuals: function() {
                const container = document.getElementById('game-visual-container');
                container.innerHTML = '';

                if(this.activeGame === 'mines') {
                    this.gridState = Array(25).fill(null); // null = hidden, 0 = gem, 1 = bomb
                    let html = '<div class="mines-board">';
                    for(let i=0; i<25; i++) {
                        html += `<div class="mine-cell" id="cell-${i}" onclick="gameManager.minesClick(${i})"></div>`;
                    }
                    html += '</div>';
                    container.innerHTML = html;
                } 
                else if (this.activeGame === 'dice') {
                    container.innerHTML = `<div class="dice-display" id="dice-result">ðŸŽ²</div>`;
                }
                else if (this.activeGame === 'limbo') {
                    container.innerHTML = `<div style="font-size:4rem; font-family:'Rajdhani'; font-weight:bold; color:var(--primary)" id="limbo-result">1.00x</div>`;
                }
                else {
                    container.innerHTML = `<div style="margin-top:100px; color:var(--text-muted); text-align:center;"><i class="fa-solid fa-hammer" style="font-size:3rem; margin-bottom:20px;"></i><br>Game Under Maintenance</div>`;
                }
            },

            handleAction: async function() {
                if(this.isPlaying) {
                    // Cashout logic for applicable games
                    if(this.activeGame === 'mines') {
                        this.cashoutMines();
                    }
                    return;
                }

                // Deduct Balance
                if(app.currentBet > app.balance) {
                    app.showToast("Insufficient Balance", "error");
                    return;
                }

                app.balance -= app.currentBet;
                await app.saveBalance();
                
                // Start Game
                this.isPlaying = true;
                const btn = document.getElementById('game-action-btn');
                btn.innerText = "CASHOUT";
                btn.className = "btn btn-secondary"; // Style change
                
                // Init Game Logic
                if(this.activeGame === 'mines') {
                    this.startMines();
                } else if (this.activeGame === 'dice') {
                    this.playDice();
                } else if (this.activeGame === 'limbo') {
                    this.playLimbo();
                }
            },

            // --- MINES LOGIC ---
            startMines: function() {
                // Determine outcome based on WinRate at START
                // Simplified: Pre-calculate if user wins or loses overall
                const roll = Math.random() * 100;
                this.willWinGlobal = roll < this.winRate;
                
                // Place Bombs
                this.gridState.fill(0); // 0 = safe
                let bombs = 3;
                while(bombs > 0) {
                    let idx = Math.floor(Math.random() * 25);
                    if(this.gridState[idx] === 0) {
                        this.gridState[idx] = 1; // 1 = bomb
                        bombs--;
                    }
                }
                
                // If Admin sets low winrate, ensure first click might be bomb or safe depending on implementation
                // For this demo, we keep grid random but multiplier might be tricky
            },

            minesClick: function(index) {
                const cell = document.getElementById(`cell-${index}`);
                if(cell.classList.contains('revealed')) return;

                cell.classList.add('revealed');

                if(this.gridState[index] === 1) {
                    // Hit Bomb
                    cell.classList.add('boom');
                    cell.innerHTML = '<i class="fa-solid fa-bomb"></i>';
                    this.endGame(false, 0);
                } else {
                    // Hit Gem
                    cell.classList.add('gem');
                    cell.innerHTML = '<i class="fa-regular fa-gem"></i>';
                    
                    // Calculate Current Multiplier (Simple: +10% per gem)
                    const revealedCount = document.querySelectorAll('.mine-cell.gem').length;
                    const mult = 1.0 + (revealedCount * 0.2);
                    document.getElementById('game-status').innerText = `Current Multiplier: ${mult.toFixed(2)}x`;
                    
                    // Reveal other bombs if lost (simulation logic)
                    if(!this.willWinGlobal && revealedCount >= 2) {
                        // Force loss on next click for demo purposes if winrate is low
                        this.gridState[index] = 1; // Cheat for demo
                    }
                }
            },

            cashoutMines: function() {
                const revealedCount = document.querySelectorAll('.mine-cell.gem').length;
                if(revealedCount === 0) return;
                
                const mult = 1.0 + (revealedCount * 0.2);
                const winAmount = Math.floor(app.currentBet * mult);
                this.endGame(true, winAmount);
            },

            // --- DICE LOGIC ---
            playDice: async function() {
                const resEl = document.getElementById('dice-result');
                let rolls = 0;
                const interval = setInterval(() => {
                    resEl.innerText = ['âš€','âš','âš‚','âšƒ','âš„','âš…'][Math.floor(Math.random()*6)];
                    rolls++;
                    if(rolls > 10) {
                        clearInterval(interval);
                        this.resolveDice();
                    }
                }, 50);
            },

            resolveDice: async function() {
                const roll = Math.floor(Math.random() * 6) + 1; // 1-6
                document.getElementById('dice-result').innerText = ['âš€','âš','âš‚','âšƒ','âš„','âš…'][roll-1];
                
                // Simple: High > 3 wins
                const win = (roll > 3);
                if(win) {
                    const amt = app.currentBet * 2;
                    this.endGame(true, amt);
                } else {
                    this.endGame(false, 0);
                }
            },

            // --- LIMBO LOGIC ---
            playLimbo: function() {
                const el = document.getElementById('limbo-result');
                let current = 1.00;
                // Target crash point (influenced by winrate)
                // If winrate is 50%, target should be > 1.5x 50% of time
                const isWin = Math.random() * 100 < this.winRate;
                const target = isWin ? (1.5 + Math.random()) : (1.0 + Math.random() * 0.4);

                const intv = setInterval(() => {
                    current += 0.05;
                    el.innerText = current.toFixed(2) + "x";
                    if(current >= target) {
                        clearInterval(intv);
                        el.innerText = target.toFixed(2) + "x";
                        el.style.color = isWin ? "var(--success)" : "var(--danger)";
                        if(isWin) this.endGame(true, Math.floor(app.currentBet * target));
                        else this.endGame(false, 0);
                    }
                }, 50);
            },

            // --- COMMON END GAME ---
            endGame: async function(isWin, amount) {
                this.isPlaying = false;
                const btn = document.getElementById('game-action-btn');
                btn.innerText = "BET";
                btn.className = "btn btn-primary";

                if(isWin) {
                    app.balance += amount;
                    document.getElementById('game-status').innerText = `YOU WON ${amount}!`;
                    document.getElementById('game-status').style.color = "var(--success)";
                    app.showToast(`You won ${amount}!`, 'success');
                    
                    // Notify Bot API if win is big
                    if(amount > 500) {
                        window.sendTelegramNotification(`User ${app.user.first_name} (ID: ${app.user.id}) won ${amount} in ${this.activeGame}!`);
                    }
                } else {
                    document.getElementById('game-status').innerText = "Game Over";
                    document.getElementById('game-status').style.color = "var(--danger)";
                }
                
                await app.saveBalance();
            }
        };

        // Initialize App
        // Wait for modules to load (timeout fallback for desktop testing without modules)
        if(window.fbDB) {
            app.init();
        } else {
            // Fallback for environments where module loading might be delayed/sync issues in simple HTML structure
            setTimeout(() => {
                if(window.fbDB) app.init();
                else {
                    alert("Error loading Firebase. Please check internet connection.");
                    app.user = { id: 1, first_name: "Offline User", photo_url: "" };
                    app.balance = 1000;
                    app.updateUI();
                }
            }, 1000);
        }

    </script>
</body>
</html>
