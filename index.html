<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Royal Diamond Casino</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #050b14;
            --bg-surface: #0f1724;
            --bg-card: #162030;
            --bg-glass: rgba(22, 32, 48, 0.7);
            --primary: #fbbf24;
            --primary-glow: rgba(251, 191, 36, 0.3);
            --secondary: #38bdf8;
            --accent: #f43f5e;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --safe-area-bottom: env(safe-area-inset-bottom);
            --nav-height: 80px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .bg-blob {
            position: fixed;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, var(--primary-glow) 0%, transparent 70%);
            top: -150px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
            pointer-events: none;
            animation: blobPulse 8s ease-in-out infinite;
        }

        @keyframes blobPulse {
            0%, 100% { opacity: 0.6; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.8; transform: translateX(-50%) scale(1.1); }
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-body);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s, visibility 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(251, 191, 36, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        /* Header */
        header {
            z-index: 10;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(5,11,20,0.95) 0%, rgba(5,11,20,0) 100%);
            position: sticky;
            top: 0;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--text-main);
            letter-spacing: 0.5px;
        }
        .brand i { color: var(--primary); }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .balance-pill {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 6px 14px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .balance-amount {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bg-card), var(--bg-surface));
            border: 2px solid var(--primary);
            overflow: hidden;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        .profile-btn:active { transform: scale(0.95); }
        .profile-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Main */
        main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            z-index: 1;
            padding: 0 16px 100px 16px;
            scrollbar-width: none;
        }
        main::-webkit-scrollbar { display: none; }

        .tab-view {
            display: none;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .tab-view.active { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.5rem;
            margin: 20px 0 16px 0;
            color: var(--text-main);
        }

        h3 {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.2rem;
            margin: 16px 0 12px 0;
            color: var(--text-main);
        }

        /* Components */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.03);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Inter', sans-serif;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #d97706);
            color: #000;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.25);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
        }
        .btn-secondary:active { background: rgba(255,255,255,0.2); }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        /* Games Grid */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .game-card {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .game-card:active { background: var(--bg-card); transform: scale(0.96); }
        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }
        .game-card:hover::before { opacity: 1; }
        .game-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--text-main);
            margin-bottom: 10px;
        }
        .game-name { font-weight: 600; font-size: 0.95rem; }

        /* User Info Card */
        .user-info-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-card), var(--bg-surface));
            border: 1px solid rgba(251, 191, 36, 0.2);
            margin-bottom: 20px;
        }
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            object-fit: cover;
        }
        .user-details h3 { margin: 0 0 4px 0; }
        .user-id { font-size: 0.8rem; color: var(--text-muted); font-family: 'Rajdhani'; }

        /* Ranking */
        .rank-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .rank-row:last-child { border-bottom: none; }
        .rank-num { width: 30px; font-weight: 700; color: var(--text-muted); font-family: 'Rajdhani'; font-size: 1.1rem; }
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        .rank-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .rank-info { flex: 1; }
        .rank-name { font-weight: 600; font-size: 0.95rem; }
        .rank-val { font-family: 'Rajdhani'; font-weight: 700; color: var(--primary); font-size: 1.1rem; }

        /* Wallet */
        .wallet-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .w-stat {
            flex: 1;
            background: var(--bg-card);
            padding: 15px;
            border-radius: var(--radius-md);
            text-align: center;
        }
        .w-stat small { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }
        .w-stat div { font-family: 'Rajdhani'; font-size: 1.2rem; font-weight: 700; margin-top: 5px; }

        .tx-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .tx-left { display: flex; gap: 12px; align-items: center; }
        .tx-icon {
            width: 36px; height: 36px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem;
        }
        .tx-amount { font-family: 'Rajdhani'; font-weight: 700; }
        .tx-plus { color: var(--success); }
        .tx-minus { color: var(--text-main); }

        /* Friends */
        .invite-card {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            text-align: center;
            padding: 30px 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .ref-box {
            background: rgba(0,0,0,0.3);
            padding: 12px 20px;
            border-radius: 8px;
            font-family: 'Rajdhani';
            font-size: 1.2rem;
            letter-spacing: 2px;
            margin: 15px 0;
            border: 1px dashed var(--secondary);
            word-break: break-all;
        }

        /* Tasks */
        .task-card {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .task-img {
            width: 50px; height: 50px;
            border-radius: 10px;
            object-fit: cover;
            background: var(--bg-surface);
        }
        .task-meta { flex: 1; }
        .task-title { font-weight: 600; margin-bottom: 4px; }
        .task-reward { font-size: 0.85rem; color: var(--primary); font-weight: 600; }

        /* Navigation */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(5, 11, 20, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-bottom: var(--safe-area-bottom);
            z-index: 50;
            height: calc(var(--nav-height) + var(--safe-area-bottom));
        }

        .nav-bar {
            display: flex;
            justify-content: space-around;
            height: var(--nav-height);
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.7rem;
            gap: 4px;
            width: 60px;
            transition: color 0.2s;
            cursor: pointer;
            background: none;
            border: none;
        }

        .nav-btn i { font-size: 1.25rem; transition: transform 0.2s; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn.active i { transform: translateY(-3px); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { margin: 0; }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
        }
        .modal-body { padding: 20px; }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .setting-item:last-child { border-bottom: none; }
        .setting-left { display: flex; align-items: center; gap: 12px; }
        .setting-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .setting-title { font-weight: 600; }
        .setting-desc { font-size: 0.8rem; color: var(--text-muted); }

        /* Toast */
        #toast-container {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 350px;
            pointer-events: none;
        }
        .toast {
            background: rgba(15, 23, 36, 0.98);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: all;
        }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.info { border-left: 4px solid var(--secondary); }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Input */
        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-sm);
            color: white;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Game Redirect Overlay */
        .game-redirect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-body);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .game-redirect-overlay.active { display: flex; }
        
        .game-loader {
            text-align: center;
        }
        .game-loader-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .game-loader h2 { margin: 0 0 10px 0; }
    </style>
</head>
<body>

    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">Connecting to Royal Diamond...</div>
    </div>

    <div class="bg-blob"></div>

    <div class="app-container">
        <header>
            <div class="brand">
                <i class="fa-solid fa-gem"></i>
                <span>ROYAL</span>
            </div>
            <div class="header-right">
                <div class="balance-pill">
                    <i class="fa-regular fa-gem" style="color:var(--primary); font-size:0.9rem;"></i>
                    <span class="balance-amount" id="global-balance">0</span>
                </div>
                <div class="profile-btn" onclick="app.openSettings()" id="profileBtn">
                    <i class="fa-solid fa-user" style="color: var(--text-muted);"></i>
                </div>
            </div>
        </header>

        <div id="toast-container"></div>

        <main>
            
            <!-- === HOME SECTION === -->
            <div id="home-view" class="tab-view active">
                <div class="user-info-card card" id="userInfoCard">
                    <img class="user-avatar" id="userAvatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23162030' width='100' height='100'/%3E%3C/svg%3E" alt="Avatar">
                    <div class="user-details">
                        <h3 id="userName">Guest User</h3>
                        <div class="user-id">ID: <span id="userIdDisplay">--</span></div>
                    </div>
                </div>

                <h2>Games</h2>
                <div class="games-grid">
                    <div class="game-card" onclick="app.openGame('mines')">
                        <div class="game-icon"><i class="fa-solid fa-bomb"></i></div>
                        <div class="game-name">Mines</div>
                    </div>
                    <div class="game-card" onclick="app.openGame('dragon-tower')">
                        <div class="game-icon"><i class="fa-brands fa-fort-awesome"></i></div>
                        <div class="game-name">Dragon Tower</div>
                    </div>
                    <div class="game-card" onclick="app.openGame('dice')">
                        <div class="game-icon"><i class="fa-solid fa-dice-d20"></i></div>
                        <div class="game-name">Dice</div>
                    </div>
                    <div class="game-card" onclick="app.openGame('limbo')">
                        <div class="game-icon"><i class="fa-solid fa-infinity"></i></div>
                        <div class="game-name">Limbo</div>
                    </div>
                    <div class="game-card" onclick="app.openGame('dragon-tiger')">
                        <div class="game-icon"><i class="fa-solid fa-dragon"></i></div>
                        <div class="game-name">Dragon Tiger</div>
                    </div>
                    <div class="game-card" onclick="app.openGame('plinko')">
                        <div class="game-icon"><i class="fa-solid fa-arrow-down-short-wide"></i></div>
                        <div class="game-name">Plinko</div>
                    </div>
                    <div class="game-card" onclick="app.openGame('crash')">
                        <div class="game-icon"><i class="fa-solid fa-chart-line"></i></div>
                        <div class="game-name">Crash</div>
                    </div>
                    <div class="game-card" onclick="app.openGame('wheel')">
                        <div class="game-icon"><i class="fa-solid fa-circle-notch"></i></div>
                        <div class="game-name">Wheel</div>
                    </div>
                </div>
            </div>

            <!-- === RANKING SECTION === -->
            <div id="ranking-view" class="tab-view">
                <h2>Leaderboard</h2>
                <div class="card">
                    <div id="ranking-list" style="padding: 0 10px;">
                        <div style="text-align:center; padding:20px; color:var(--text-muted);">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- === WALLET SECTION === -->
            <div id="wallet-view" class="tab-view">
                <h2>Wallet</h2>
                
                <div class="wallet-stats">
                    <div class="w-stat">
                        <small>Balance</small>
                        <div style="color:var(--primary)" id="wallet-balance">0</div>
                    </div>
                    <div class="w-stat">
                        <small>Total Wagered</small>
                        <div style="color:var(--secondary)" id="totalWagered">0</div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="app.deposit()"><i class="fa-solid fa-plus"></i> Deposit</button>
                    <button class="btn btn-secondary" onclick="app.withdraw()"><i class="fa-solid fa-arrow-up"></i> Withdraw</button>
                </div>

                <h3>Recent Activity</h3>
                <div class="card" style="padding: 0 16px;">
                    <div id="transaction-list">
                        <div style="text-align:center; padding:20px; color:var(--text-muted);">No activity yet</div>
                    </div>
                </div>
            </div>

            <!-- === FRIENDS SECTION === -->
            <div id="friends-view" class="tab-view">
                <h2>Invite Friends</h2>
                <div class="card invite-card">
                    <i class="fa-solid fa-gift" style="font-size:3rem; color:var(--primary); margin-bottom:15px;"></i>
                    <h3>Earn 10% Commission</h3>
                    <p style="color:var(--text-muted); font-size:0.9rem; margin:10px 0;">Invite friends and earn 10% of their deposits!</p>
                    
                    <div class="ref-box" id="ref-code">Loading...</div>
                    <button class="btn btn-primary" onclick="app.copyRef()"><i class="fa-solid fa-copy"></i> Copy Invite Link</button>
                </div>

                <h3>Your Referrals</h3>
                <div class="card" id="referrals-list">
                    <div style="text-align:center; padding:20px; color:var(--text-muted);">No referrals yet</div>
                </div>
            </div>

            <!-- === TASKS SECTION === -->
            <div id="tasks-view" class="tab-view">
                <h2>Daily Tasks</h2>
                <div id="task-list">
                    <div style="text-align:center; padding:20px; color:var(--text-muted);">Loading tasks...</div>
                </div>
            </div>

        </main>

        <nav>
            <div class="nav-bar">
                <button class="nav-btn active" onclick="app.nav('home', this)">
                    <i class="fa-solid fa-house"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" onclick="app.nav('ranking', this)">
                    <i class="fa-solid fa-trophy"></i>
                    <span>Ranking</span>
                </button>
                <button class="nav-btn" onclick="app.nav('wallet', this)">
                    <i class="fa-solid fa-wallet"></i>
                    <span>Wallet</span>
                </button>
                <button class="nav-btn" onclick="app.nav('friends', this)">
                    <i class="fa-solid fa-user-group"></i>
                    <span>Friends</span>
                </button>
                <button class="nav-btn" onclick="app.nav('tasks', this)">
                    <i class="fa-solid fa-list-check"></i>
                    <span>Tasks</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="modal-close" onclick="app.closeSettings()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="user-info-card card" style="margin-bottom: 20px;">
                    <img class="user-avatar" id="settingsAvatar" src="" alt="Avatar">
                    <div class="user-details">
                        <h3 id="settingsName">User</h3>
                        <div class="user-id">ID: <span id="settingsId">--</span></div>
                    </div>
                </div>

                <div class="setting-item" onclick="app.connectTonWallet()">
                    <div class="setting-left">
                        <div class="setting-icon"><i class="fa-solid fa-wallet" style="color: var(--primary);"></i></div>
                        <div>
                            <div class="setting-title">Connect TON Wallet</div>
                            <div class="setting-desc">Connect your wallet for withdrawals</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color: var(--text-muted);"></i>
                </div>

                <div class="setting-item" onclick="app.openMonarch()">
                    <div class="setting-left">
                        <div class="setting-icon"><i class="fa-solid fa-gamepad" style="color: var(--secondary);"></i></div>
                        <div>
                            <div class="setting-title">More Games</div>
                            <div class="setting-desc">Play at Monarch Casino</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-external-link" style="color: var(--text-muted);"></i>
                </div>

                <div class="setting-item" onclick="app.showUserStats()">
                    <div class="setting-left">
                        <div class="setting-icon"><i class="fa-solid fa-chart-bar" style="color: var(--success);"></i></div>
                        <div>
                            <div class="setting-title">Your Statistics</div>
                            <div class="setting-desc">View your gaming history</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color: var(--text-muted);"></i>
                </div>

                <div class="setting-item" onclick="app.support()">
                    <div class="setting-left">
                        <div class="setting-icon"><i class="fa-solid fa-headset" style="color: var(--accent);"></i></div>
                        <div>
                            <div class="setting-title">Support</div>
                            <div class="setting-desc">Get help from our team</div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color: var(--text-muted);"></i>
                </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.05); text-align: center;">
                    <small style="color: var(--text-muted);">Royal Diamond Casino v2.0</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Redirect Overlay -->
    <div class="game-redirect-overlay" id="gameRedirect">
        <div class="game-loader">
            <div class="game-loader-icon" id="gameLoaderIcon"><i class="fa-solid fa-dice"></i></div>
            <h2 id="gameLoaderTitle">Loading Game...</h2>
            <p style="color: var(--text-muted);">Preparing your experience</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBD8tW5sHlSze2E4E-EjXSjx9eMBdnneQ4",
            authDomain: "free-money-9b371.firebaseapp.com",
            databaseURL: "https://free-money-9b371-default-rtdb.firebaseio.com",
            projectId: "free-money-9b371",
            storageBucket: "free-money-9b371.firebasestorage.app",
            messagingSenderId: "331937781056",
            appId: "1:331937781056:web:ab7fdba321b4053be7d6a5",
            measurementId: "G-ZGC6B44FDV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // Telegram Configuration
        const TELEGRAM_BOT_TOKEN = '8583171793:AAEg649kmH347L4Y6bfVKaDmb5d_r2yn6vw';
        const MONARCH_LINK = 'https://monarch-play.vercel.app/';

        // Game Links (these would be your actual game pages)
        const GAME_LINKS = {
            'mines': 'games/mines.html',
            'dragon-tower': 'games/dragon-tower.html',
            'dice': 'games/dice.html',
            'limbo': 'games/limbo.html',
            'dragon-tiger': 'games/dragon-tiger.html',
            'plinko': 'games/plinko.html',
            'crash': 'games/crash.html',
            'wheel': 'games/wheel.html'
        };

        // Main Application
        const app = {
            user: null,
            tgUser: null,
            tg: null,

            init: async function() {
                // Initialize Telegram WebApp
                if (window.Telegram && window.Telegram.WebApp) {
                    this.tg = window.Telegram.WebApp;
                    this.tg.ready();
                    this.tg.expand();
                    
                    if (this.tg.initDataUnsafe && this.tg.initDataUnsafe.user) {
                        this.tgUser = this.tg.initDataUnsafe.user;
                    }
                }

                // Check for Telegram user
                if (this.tgUser) {
                    await this.loadOrCreateUser();
                } else {
                    // For testing outside Telegram
                    await this.createGuestUser();
                }

                // Setup presence
                this.setupPresence();

                // Load initial data
                await this.loadTasks();
                await this.loadRanking();

                // Hide loading screen
                document.getElementById('loadingScreen').classList.add('hidden');
            },

            loadOrCreateUser: async function() {
                const userId = this.tgUser.id.toString();
                const userRef = database.ref(`users/${userId}`);

                try {
                    const snapshot = await userRef.once('value');
                    
                    if (snapshot.exists()) {
                        this.user = snapshot.val();
                        // Update last seen and online status
                        await userRef.update({
                            lastSeen: Date.now(),
                            online: true,
                            name: this.tgUser.first_name + (this.tgUser.last_name ? ' ' + this.tgUser.last_name : '')
                        });
                    } else {
                        // Create new user
                        const referrerId = this.getReferrerId();
                        const newUser = {
                            id: userId,
                            name: this.tgUser.first_name + (this.tgUser.last_name ? ' ' + this.tgUser.last_name : ''),
                            balance: 1000, // Starting balance
                            totalWagered: 0,
                            totalWon: 0,
                            referrals: 0,
                            referralEarnings: 0,
                            referredBy: referrerId || null,
                            createdAt: Date.now(),
                            lastSeen: Date.now(),
                            online: true,
                            banned: false,
                            photoUrl: this.tgUser.photo_url || null,
                            tasks: {},
                            transactions: []
                        };
                        
                        await userRef.set(newUser);
                        this.user = newUser;

                        // Handle referral bonus
                        if (referrerId) {
                            await this.handleReferral(referrerId);
                        }
                    }

                    // Setup real-time listener
                    userRef.on('value', (snap) => {
                        this.user = snap.val();
                        this.updateUI();
                    });

                    this.updateUI();
                } catch (error) {
                    console.error('Error loading user:', error);
                    this.showToast('Connection error. Please refresh.', 'error');
                }
            },

            createGuestUser: async function() {
                const guestId = 'guest_' + Date.now();
                const userRef = database.ref(`users/${guestId}`);
                
                const guestUser = {
                    id: guestId,
                    name: 'Guest User',
                    balance: 1000,
                    totalWagered: 0,
                    totalWon: 0,
                    referrals: 0,
                    referralEarnings: 0,
                    referredBy: null,
                    createdAt: Date.now(),
                    lastSeen: Date.now(),
                    online: true,
                    banned: false,
                    photoUrl: null,
                    tasks: {},
                    transactions: []
                };

                await userRef.set(guestUser);
                this.user = guestUser;

                userRef.on('value', (snap) => {
                    this.user = snap.val();
                    this.updateUI();
                });

                this.updateUI();
            },

            getReferrerId: function() {
                // Check URL params for referrer
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('ref') || urlParams.get('startapp');
            },

            handleReferral: async function(referrerId) {
                const referrerRef = database.ref(`users/${referrerId}`);
                const snapshot = await referrerRef.once('value');
                
                if (snapshot.exists()) {
                    const referrer = snapshot.val();
                    const bonus = 500; // Referral bonus

                    await referrerRef.update({
                        referrals: (referrer.referrals || 0) + 1,
                        balance: (referrer.balance || 0) + bonus,
                        referralEarnings: (referrer.referralEarnings || 0) + bonus
                    });

                    // Log transaction for referrer
                    await this.logTransaction(referrerId, 'referral', bonus);
                }
            },

            setupPresence: function() {
                if (!this.user) return;

                const userId = this.user.id;
                const presenceRef = database.ref(`presence/${userId}`);
                const userRef = database.ref(`users/${userId}`);

                // Set online
                presenceRef.set(true);
                userRef.update({ online: true, lastSeen: Date.now() });

                // Handle disconnect
                presenceRef.onDisconnect().set(false);
                userRef.onDisconnect().update({ online: false, lastSeen: Date.now() });
            },

            updateUI: function() {
                if (!this.user) return;

                // Update balance
                const balance = this.user.balance || 0;
                const formattedBalance = new Intl.NumberFormat().format(balance);
                document.getElementById('global-balance').innerText = formattedBalance;
                document.getElementById('wallet-balance').innerText = formattedBalance;
                document.getElementById('totalWagered').innerText = new Intl.NumberFormat().format(this.user.totalWagered || 0);

                // Update user info
                document.getElementById('userName').innerText = this.user.name || 'User';
                document.getElementById('userIdDisplay').innerText = this.user.id;
                document.getElementById('settingsName').innerText = this.user.name || 'User';
                document.getElementById('settingsId').innerText = this.user.id;

                // Update avatar
                if (this.user.photoUrl) {
                    document.getElementById('userAvatar').src = this.user.photoUrl;
                    document.getElementById('settingsAvatar').src = this.user.photoUrl;
                    document.getElementById('profileBtn').innerHTML = `<img src="${this.user.photoUrl}" alt="Avatar">`;
                } else {
                    const initial = (this.user.name || 'U').charAt(0).toUpperCase();
                    document.getElementById('profileBtn').innerHTML = `<span style="color: var(--primary); font-weight: bold;">${initial}</span>`;
                }

                // Update referral code
                document.getElementById('ref-code').innerText = `https://t.me/your_bot?startapp=${this.user.id}`;

                // Update transactions
                this.renderTransactions();

                // Check if banned
                if (this.user.banned) {
                    this.showToast('Your account has been banned.', 'error');
                    document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#050b14;color:white;text-align:center;padding:20px;"><div><h1>Account Banned</h1><p>Contact support for assistance.</p></div></div>';
                }
            },

            logTransaction: async function(userId, type, amount) {
                const txRef = database.ref(`users/${userId}/transactions`).push();
                await txRef.set({
                    type: type,
                    amount: amount,
                    timestamp: Date.now()
                });
            },

            renderTransactions: function() {
                const container = document.getElementById('transaction-list');
                const transactions = this.user?.transactions || {};

                if (Object.keys(transactions).length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">No activity yet</div>';
                    return;
                }

                const sortedTx = Object.entries(transactions)
                    .sort((a, b) => b[1].timestamp - a[1].timestamp)
                    .slice(0, 20);

                const html = sortedTx.map(([id, tx]) => {
                    const isPlus = ['deposit', 'win', 'task', 'referral', 'bonus'].includes(tx.type);
                    const icon = this.getTransactionIcon(tx.type);
                    
                    return `
                        <div class="tx-item">
                            <div class="tx-left">
                                <div class="tx-icon"><i class="fa-solid ${icon}"></i></div>
                                <div>
                                    <div style="font-size:0.9rem; font-weight:600; text-transform:capitalize;">${tx.type}</div>
                                    <div style="font-size:0.75rem; color:var(--text-muted);">${new Date(tx.timestamp).toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="tx-amount ${isPlus ? 'tx-plus' : 'tx-minus'}">
                                ${isPlus ? '+' : '-'}${new Intl.NumberFormat().format(Math.abs(tx.amount))}
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            },

            getTransactionIcon: function(type) {
                const icons = {
                    'deposit': 'fa-arrow-down',
                    'withdraw': 'fa-arrow-up',
                    'win': 'fa-trophy',
                    'loss': 'fa-times',
                    'task': 'fa-check',
                    'referral': 'fa-user-plus',
                    'bonus': 'fa-gift',
                    'bet': 'fa-coins'
                };
                return icons[type] || 'fa-circle';
            },

            // Navigation
            nav: function(viewId, el) {
                document.querySelectorAll('.tab-view').forEach(v => v.classList.remove('active'));
                document.getElementById(viewId + '-view').classList.add('active');
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                el.classList.add('active');

                if (viewId === 'ranking') this.loadRanking();
                if (viewId === 'tasks') this.loadTasks();
            },

            // Games
            openGame: function(gameName) {
                if (!this.user) {
                    this.showToast('Please wait...', 'info');
                    return;
                }

                if (this.user.banned) {
                    this.showToast('Account suspended', 'error');
                    return;
                }

                const icons = {
                    'mines': 'fa-bomb',
                    'dragon-tower': 'fa-fort-awesome',
                    'dice': 'fa-dice-d20',
                    'limbo': 'fa-infinity',
                    'dragon-tiger': 'fa-dragon',
                    'plinko': 'fa-arrow-down-short-wide',
                    'crash': 'fa-chart-line',
                    'wheel': 'fa-circle-notch'
                };

                document.getElementById('gameLoaderIcon').innerHTML = `<i class="fa-solid ${icons[gameName] || 'fa-gamepad'}"></i>`;
                document.getElementById('gameLoaderTitle').innerText = gameName.replace('-', ' ').toUpperCase();
                document.getElementById('gameRedirect').classList.add('active');

                // Store current user data in localStorage for the game page
                localStorage.setItem('royal_user', JSON.stringify(this.user));
                localStorage.setItem('royal_user_id', this.user.id);

                // Redirect to game page
                setTimeout(() => {
                    window.location.href = GAME_LINKS[gameName] + '?uid=' + this.user.id;
                }, 1500);
            },

            // Tasks
            loadTasks: async function() {
                const container = document.getElementById('task-list');
                
                try {
                    const snapshot = await database.ref('tasks').once('value');
                    const tasks = snapshot.val() || {};

                    if (Object.keys(tasks).length === 0) {
                        container.innerHTML = '<div class="card" style="text-align:center; padding:30px;"><i class="fa-solid fa-clipboard-list" style="font-size:3rem; color:var(--text-muted); margin-bottom:15px;"></i><p style="color:var(--text-muted);">No tasks available</p></div>';
                        return;
                    }

                    const html = Object.entries(tasks).map(([id, task]) => {
                        const isCompleted = this.user?.tasks?.[id]?.completed;
                        
                        return `
                            <div class="card task-card">
                                <img src="${task.photoUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Crect fill=\'%23162030\' width=\'100\' height=\'100\'/%3E%3C/svg%3E'}" class="task-img" alt="${task.name}">
                                <div class="task-meta">
                                    <div class="task-title">${task.name}</div>
                                    <div class="task-reward">+${task.reward} Diamonds</div>
                                </div>
                                <button class="btn ${isCompleted ? 'btn-secondary' : 'btn-primary'}" 
                                    style="width:auto; padding:8px 16px; font-size:0.8rem;" 
                                    onclick="app.completeTask('${id}', ${task.reward}, '${task.link || ''}')"
                                    ${isCompleted ? 'disabled' : ''}>
                                    ${isCompleted ? 'Done' : 'Start'}
                                </button>
                            </div>
                        `;
                    }).join('');

                    container.innerHTML = html;
                } catch (error) {
                    console.error('Error loading tasks:', error);
                    container.innerHTML = '<div class="card" style="text-align:center; padding:30px;"><p style="color:var(--text-muted);">Failed to load tasks</p></div>';
                }
            },

            completeTask: async function(taskId, reward, link) {
                if (!this.user) return;

                // Open link if provided
                if (link) {
                    window.open(link, '_blank');
                }

                // Mark as completed and add reward
                const userRef = database.ref(`users/${this.user.id}`);
                
                await userRef.update({
                    balance: (this.user.balance || 0) + reward,
                    [`tasks/${taskId}/completed`]: true,
                    [`tasks/${taskId}/completedAt`]: Date.now()
                });

                await this.logTransaction(this.user.id, 'task', reward);
                this.showToast(`Task completed! +${reward} Diamonds`, 'success');
            },

            // Ranking
            loadRanking: async function() {
                const container = document.getElementById('ranking-list');
                container.innerHTML = '<div style="text-align:center; padding:20px;"><div class="loader" style="width:30px;height:30px;margin:auto;"></div></div>';

                try {
                    const snapshot = await database.ref('users')
                        .orderByChild('balance')
                        .limitToLast(100)
                        .once('value');

                    const users = [];
                    snapshot.forEach(child => {
                        const u = child.val();
                        if (!u.banned) {
                            users.push(u);
                        }
                    });

                    users.sort((a, b) => (b.balance || 0) - (a.balance || 0));

                    const html = users.slice(0, 50).map((u, i) => {
                        const rankClass = i < 3 ? `rank-${i + 1}` : '';
                        const isCurrentUser = u.id === this.user?.id;
                        
                        return `
                            <div class="rank-row" style="${isCurrentUser ? 'background: rgba(251,191,36,0.1); border-radius: 10px; padding: 12px; margin: -12px; margin-bottom: 0;' : ''}">
                                <div class="rank-num ${rankClass}">${i + 1}</div>
                                <img class="rank-avatar" src="${u.photoUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Crect fill=\'%23162030\' width=\'100\' height=\'100\'/%3E%3Ctext x=\'50\' y=\'60\' text-anchor=\'middle\' fill=\'%2394a3b8\' font-size=\'40\' font-family=\'Inter\'%3E${(u.name || 'U').charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E'}" alt="${u.name}">
                                <div class="rank-info">
                                    <div class="rank-name">${u.name || 'Unknown'}${isCurrentUser ? ' (You)' : ''}</div>
                                </div>
                                <div class="rank-val">${new Intl.NumberFormat().format(u.balance || 0)}</div>
                            </div>
                        `;
                    }).join('');

                    container.innerHTML = html;
                } catch (error) {
                    console.error('Error loading ranking:', error);
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">Failed to load ranking</div>';
                }
            },

            // Wallet actions
            deposit: function() {
                this.showToast('Deposit feature coming soon!', 'info');
            },

            withdraw: function() {
                if (!this.user) return;
                
                if (this.user.balance < 1000) {
                    this.showToast('Minimum withdrawal: 1,000 Diamonds', 'error');
                    return;
                }

                this.showToast('Withdrawal request submitted!', 'success');
            },

            // Referral
            copyRef: function() {
                const link = document.getElementById('ref-code').innerText;
                navigator.clipboard.writeText(link).then(() => {
                    this.showToast('Invite link copied!', 'success');
                }).catch(() => {
                    this.showToast('Failed to copy', 'error');
                });
            },

            // Settings
            openSettings: function() {
                document.getElementById('settingsModal').classList.add('active');
            },

            closeSettings: function() {
                document.getElementById('settingsModal').classList.remove('active');
            },

            connectTonWallet: async function() {
                this.showToast('TON Wallet connection coming soon!', 'info');
            },

            openMonarch: function() {
                window.open(MONARCH_LINK, '_blank');
            },

            showUserStats: function() {
                if (!this.user) return;
                this.showToast(`Total Wagered: ${new Intl.NumberFormat().format(this.user.totalWagered || 0)} | Won: ${new Intl.NumberFormat().format(this.user.totalWon || 0)}`, 'info');
            },

            support: function() {
                window.open(`https://t.me/your_support_bot`, '_blank');
            },

            // Toast
            showToast: function(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    'success': 'fa-check-circle',
                    'error': 'fa-circle-exclamation',
                    'info': 'fa-info-circle'
                };

                toast.innerHTML = `<i class="fa-solid ${icons[type] || icons.info}"></i> <span>${msg}</span>`;
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        };

        // Telegram WebApp Script
        const tgScript = document.createElement('script');
        tgScript.src = 'https://telegram.org/js/telegram-web-app.js';
        tgScript.onload = () => app.init();
        tgScript.onerror = () => app.init();
        document.body.appendChild(tgScript);
    </script>
</body>
</html>
